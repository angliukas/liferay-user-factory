<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Liferay User Factory</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { border: 1px solid #ccc; padding: 20px; border-radius: 6px; }
        .status { margin-top: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
        .hidden { display: none; }
    </style>
</head>
<body>
<div class="container">
    <h1>Liferay User Factory</h1>
    <div class="card">
        <p>Upload an Excel file (.xlsx) with columns: email, name, surname.</p>
        <div style="margin-bottom: 10px;">
            <label for="organizationSelect">Organization:</label>
            <select id="organizationSelect">
                <option value="">-- none --</option>
            </select>
        </div>
        <div style="margin-bottom: 10px;">
            <label for="rolesSelect">Roles:</label>
            <select id="rolesSelect" multiple size="5" style="width: 100%;"></select>
        </div>
        <input type="file" id="fileInput" accept=".xlsx">
        <button id="uploadBtn">Upload</button>
        <div id="error" class="status" style="color: red"></div>
        <div id="summary" class="status hidden"></div>
        <div id="failures" class="status hidden">
            <h3>Failed rows</h3>
            <table>
                <thead>
                <tr><th>Row</th><th>Email</th><th>Name</th><th>Surname</th><th>Reason</th></tr>
                </thead>
                <tbody id="failureRows"></tbody>
            </table>
        </div>
    </div>
</div>
<script>
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');
    const errorBox = document.getElementById('error');
    const summary = document.getElementById('summary');
    const failures = document.getElementById('failures');
    const failureRows = document.getElementById('failureRows');
    const organizationSelect = document.getElementById('organizationSelect');
    const rolesSelect = document.getElementById('rolesSelect');

    async function loadOrganizations() {
        try {
            const response = await fetch('/api/users/organizations');
            if (!response.ok) {
                throw new Error('Unable to load organizations');
            }
            const organizations = await response.json();
            organizations.forEach(org => {
                const option = document.createElement('option');
                option.value = org.id;
                option.textContent = org.name;
                organizationSelect.appendChild(option);
            });
        } catch (e) {
            errorBox.textContent = e.message;
        }
    }

    async function loadRoles() {
        try {
            const response = await fetch('/api/users/roles');
            if (!response.ok) {
                throw new Error('Unable to load roles');
            }
            const roles = await response.json();
            roles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.id;
                option.textContent = role.name;
                rolesSelect.appendChild(option);
            });
        } catch (e) {
            errorBox.textContent = e.message;
        }
    }

    loadOrganizations();
    loadRoles();

    uploadBtn.addEventListener('click', async () => {
        errorBox.textContent = '';
        summary.classList.add('hidden');
        failures.classList.add('hidden');
        failureRows.innerHTML = '';

        if (!fileInput.files.length) {
            errorBox.textContent = 'Please choose a file to upload.';
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        if (organizationSelect.value) {
            formData.append('organizationId', organizationSelect.value);
        }
        Array.from(rolesSelect.selectedOptions).forEach(option => {
            formData.append('roleIds', option.value);
        });

        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Uploading...';

        try {
            const response = await fetch('/api/users/import', {
                method: 'POST',
                body: formData
            });
            if (!response.ok) {
                throw new Error('Upload failed: ' + response.statusText);
            }
            const result = await response.json();
            summary.innerHTML = `Imported <strong>${result.created}</strong> of <strong>${result.totalRows}</strong> rows.`;
            summary.classList.remove('hidden');

            if (result.failures && result.failures.length) {
                failures.classList.remove('hidden');
                result.failures.forEach(f => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${f.rowIndex}</td><td>${f.user?.email || ''}</td><td>${f.user?.firstName || ''}</td><td>${f.user?.lastName || ''}</td><td>${f.reason}</td>`;
                    failureRows.appendChild(tr);
                });
            }
        } catch (e) {
            errorBox.textContent = e.message;
        } finally {
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Upload';
        }
    });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Liferay User Factory</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { border: 1px solid #ccc; padding: 20px; border-radius: 6px; }
        .status { margin-top: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
        .hidden { display: none; }
    </style>
</head>
<body>
<div class="container">
    <h1>Liferay User Factory</h1>
    <div class="card">
        <p>Upload an Excel file (.xlsx) with columns: email, name, surname.</p>
        <div style="margin-bottom: 10px;">
            <label for="organizationSelect">Organization:</label>
            <input type="text" id="organizationSearch" placeholder="Search organizations" style="width: 100%; margin: 4px 0;" />
            <select id="organizationSelect">
                <option value="">-- select an organization --</option>
            </select>
        </div>
        <input type="file" id="fileInput" accept=".xlsx">
        <button id="uploadBtn">Upload</button>
        <div id="error" class="status" style="color: red"></div>
        <div id="summary" class="status hidden"></div>
        <div id="validation" class="status hidden">
            <h3>Validation errors</h3>
            <table>
                <thead>
                <tr><th>Row</th><th>Email</th><th>Name</th><th>Surname</th><th>Reason</th></tr>
                </thead>
                <tbody id="validationRows"></tbody>
            </table>
        </div>
        <div id="imported" class="status hidden">
            <h3>Imported users</h3>
            <table>
                <thead>
                <tr><th>User ID</th><th>Email</th><th>Created</th></tr>
                </thead>
                <tbody id="importedRows"></tbody>
            </table>
        </div>
        <div id="existing" class="status hidden">
            <h3>Existing users</h3>
            <table>
                <thead>
                <tr><th>User ID</th><th>Email</th><th>Created</th></tr>
                </thead>
                <tbody id="existingRows"></tbody>
            </table>
        </div>
        <div id="failures" class="status hidden">
            <h3>Failed rows</h3>
            <table>
                <thead>
                <tr><th>Row</th><th>Email</th><th>Name</th><th>Surname</th><th>Reason</th></tr>
                </thead>
                <tbody id="failureRows"></tbody>
            </table>
        </div>
    </div>
</div>
<script>
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');
    const errorBox = document.getElementById('error');
    const summary = document.getElementById('summary');
    const imported = document.getElementById('imported');
    const importedRows = document.getElementById('importedRows');
    const existing = document.getElementById('existing');
    const existingRows = document.getElementById('existingRows');
    const validation = document.getElementById('validation');
    const validationRows = document.getElementById('validationRows');
    const failures = document.getElementById('failures');
    const failureRows = document.getElementById('failureRows');
    const organizationSelect = document.getElementById('organizationSelect');
    const organizationSearch = document.getElementById('organizationSearch');

    let organizationsCache = [];

    function formatDate(value) {
        if (!value) {
            return '';
        }

        if (Array.isArray(value)) {
            const [year, month = 1, day = 1, hour = 0, minute = 0, second = 0, nano = 0] = value;
            const dateFromArray = new Date(Date.UTC(year, month - 1, day, hour, minute, second, Math.floor(nano / 1_000_000)));
            return Number.isNaN(dateFromArray.getTime()) ? '' : dateFromArray.toLocaleString();
        }

        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
            return '';
        }

        return date.toLocaleString();
    }

    function renderOrganizations(filter = '') {
        const normalizedFilter = filter.trim().toLowerCase();
        organizationSelect.innerHTML = '<option value="">-- select an organization --</option>';
        organizationsCache
            .filter(org => org.name.toLowerCase().includes(normalizedFilter))
            .forEach(org => {
                const option = document.createElement('option');
                option.value = org.id;
                option.textContent = org.name;
                organizationSelect.appendChild(option);
            });
    }

    async function loadOrganizations() {
        try {
            const response = await fetch('/api/users/organizations');
            if (!response.ok) {
                throw new Error('Unable to load organizations');
            }
            organizationsCache = await response.json();
            renderOrganizations(organizationSearch.value);
        } catch (e) {
            errorBox.textContent = e.message;
        }
    }

    loadOrganizations();

    organizationSearch.addEventListener('input', () => {
        renderOrganizations(organizationSearch.value);
    });

    uploadBtn.addEventListener('click', async () => {
        errorBox.textContent = '';
        summary.classList.add('hidden');
        imported.classList.add('hidden');
        importedRows.innerHTML = '';
        existing.classList.add('hidden');
        existingRows.innerHTML = '';
        validation.classList.add('hidden');
        validationRows.innerHTML = '';
        failures.classList.add('hidden');
        failureRows.innerHTML = '';

        if (!fileInput.files.length) {
            errorBox.textContent = 'Please choose a file to upload.';
            return;
        }

        if (!organizationSelect.value) {
            errorBox.textContent = 'Please select an organization.';
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('organizationId', organizationSelect.value);

        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Uploading...';

        try {
            const response = await fetch('/api/users/import', {
                method: 'POST',
                body: formData
            });
            if (!response.ok) {
                throw new Error('Upload failed: ' + response.statusText);
            }
            const result = await response.json();
            summary.innerHTML = `Imported <strong>${result.created}</strong> of <strong>${result.totalRows}</strong> rows.`;
            summary.classList.remove('hidden');

            if (result.importedUsers && result.importedUsers.length) {
                imported.classList.remove('hidden');
                result.importedUsers.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${user.id ?? ''}</td><td>${user.emailAddress ?? ''}</td><td>${formatDate(user.createDate)}</td>`;
                    importedRows.appendChild(tr);
                });
            }

            if (result.existingUsers && result.existingUsers.length) {
                existing.classList.remove('hidden');
                result.existingUsers.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${user.id ?? ''}</td><td>${user.emailAddress ?? ''}</td><td>${formatDate(user.createDate)}</td>`;
                    existingRows.appendChild(tr);
                });
            }

            if (result.validationErrors && result.validationErrors.length) {
                validation.classList.remove('hidden');
                result.validationErrors.forEach(v => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${v.rowIndex}</td><td>${v.user?.email || ''}</td><td>${v.user?.firstName || ''}</td><td>${v.user?.lastName || ''}</td><td>${v.reason}</td>`;
                    validationRows.appendChild(tr);
                });
            }

            if (result.failures && result.failures.length) {
                failures.classList.remove('hidden');
                result.failures.forEach(f => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${f.rowIndex}</td><td>${f.user?.email || ''}</td><td>${f.user?.firstName || ''}</td><td>${f.user?.lastName || ''}</td><td>${f.reason}</td>`;
                    failureRows.appendChild(tr);
                });
            }
        } catch (e) {
            errorBox.textContent = e.message;
        } finally {
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Upload';
        }
    });
</script>
</body>
</html>
